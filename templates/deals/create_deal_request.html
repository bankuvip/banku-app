{% extends "base.html" %}

{% block title %}Create Deal Request - BankU{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2 mb-0">
                    <i class="fas fa-plus-circle me-2"></i>Create Deal Request
                </h1>
                <a href="{{ url_for('deals.my_deal_requests') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to My Requests
                </a>
            </div>
        </div>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <!-- Warning Message -->
                    <div class="alert alert-warning border-0 mb-4">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-exclamation-triangle me-3 mt-1"></i>
                            <div>
                                <h6 class="alert-heading mb-2">Important Notice</h6>
                                <p class="mb-0 small">
                                    <strong>Please only create requests for items you genuinely need.</strong> 
                                    Fake or spam requests may result in account restrictions. 
                                    Be specific about your requirements to help connectors assist you better.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <form id="createRequestForm" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <!-- Item Selection -->
                        {% if item %}
                        <div class="mb-4">
                            <label class="form-label fw-bold">Selected Item</label>
                            <div class="card bg-light border-0 p-3">
                                <div class="d-flex align-items-center">
                                    {% if item.image_url %}
                                    <img src="{{ item.image_url }}" alt="{{ item.title }}" class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-secondary rounded d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                                        <i class="fas fa-image text-white"></i>
                                    </div>
                                    {% endif %}
                                    <div>
                                        <h6 class="mb-1">{{ item.title }}</h6>
                                        <p class="text-muted mb-0 small">{{ item.short_description[:100] }}{% if item.short_description|length > 100 %}...{% endif %}</p>
                                        <small class="text-muted">by {{ item.organization_associations[0].organization.name if item.organization_associations else 'Unknown Organization' }}</small>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="item_id" value="{{ item.id }}">
                        </div>
                        {% else %}
                        <div class="mb-4">
                            <label for="item_search" class="form-label fw-bold">Search for Item</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="item_search" placeholder="Search for items...">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchItems()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="item_results" class="mt-3" style="display: none;"></div>
                            <input type="hidden" name="item_id" id="selected_item_id">
                        </div>
                        {% endif %}
                        
                        <!-- Request Details -->
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label for="title" class="form-label fw-bold">Request Title <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" required 
                                       placeholder="Brief title describing your need">
                            </div>
                            <div class="col-md-4">
                                <label for="urgency_level" class="form-label fw-bold">Urgency Level</label>
                                <select class="form-select" id="urgency_level" name="urgency_level">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="need_description" class="form-label fw-bold">Detailed Description <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="need_description" name="need_description" rows="4" required
                                      placeholder="Describe your specific needs, requirements, and any important details..."></textarea>
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="category" class="form-label fw-bold">Category</label>
                                <select class="form-select" id="category" name="category">
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.name }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="budget_min" class="form-label fw-bold">Minimum Budget</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="budget_min" name="budget_min" 
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="budget_max" class="form-label fw-bold">Maximum Budget</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="budget_max" name="budget_max" 
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="timeline" class="form-label fw-bold">Timeline</label>
                            <input type="text" class="form-control" id="timeline" name="timeline" 
                                   placeholder="e.g., Within 2 weeks, ASAP, Flexible">
                        </div>
                        
                        <div class="mb-4">
                            <label for="special_requirements" class="form-label fw-bold">Special Requirements</label>
                            <textarea class="form-control" id="special_requirements" name="special_requirements" rows="3"
                                      placeholder="Any special requirements, preferences, or additional information..."></textarea>
                        </div>
                        
                        <div class="mb-4">
                            <label for="tags" class="form-label fw-bold">Tags</label>
                            <input type="text" class="form-control" id="tags" name="tags" 
                                   placeholder="Enter tags separated by commas (e.g., urgent, design, consultation)">
                            <small class="form-text text-muted">Tags help connectors understand your request better</small>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="d-flex justify-content-end gap-3">
                            <a href="{{ url_for('deals.my_deal_requests') }}" class="btn btn-outline-secondary">
                                Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-paper-plane me-1"></i>Create Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    transition: box-shadow 0.2s ease;
}

.card:hover {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.item-result {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.item-result:hover {
    background-color: #f8f9fa;
}

.btn {
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
}
</style>

<script>
document.getElementById('createRequestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';
    
    const formData = new FormData(this);
    
    fetch('{{ url_for("deals.create_deal_request") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => {
                window.location.href = `/deals/my-deal-requests/${data.request_id}`;
            }, 1000);
        } else {
            showAlert('error', data.message);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Failed to create request');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
});

function searchItems() {
    const query = document.getElementById('item_search').value;
    if (!query.trim()) {
        showAlert('warning', 'Please enter a search term');
        return;
    }
    
    const resultsDiv = document.getElementById('item_results');
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
    
    fetch(`/banks/search-items?q=${encodeURIComponent(query)}`)
    .then(response => response.json())
    .then(data => {
        if (data.success && data.items.length > 0) {
            let html = '<h6 class="mb-3">Search Results:</h6>';
            data.items.forEach(item => {
                html += `
                    <div class="item-result card border-0 shadow-sm mb-2 p-3" onclick="selectItem(${item.id}, '${item.title}', '${item.description}', '${item.organization_name}')">
                        <div class="d-flex align-items-center">
                            <div class="bg-secondary rounded d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                                <i class="fas fa-image text-white"></i>
                            </div>
                            <div>
                                <h6 class="mb-1">${item.title}</h6>
                                <p class="text-muted mb-0 small">${item.short_description.substring(0, 100)}...</p>
                                <small class="text-muted">by ${item.organization_name}</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = '<div class="text-center text-muted">No items found</div>';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        resultsDiv.innerHTML = '<div class="text-center text-danger">Error searching items</div>';
    });
}

function selectItem(itemId, title, description, organizationName) {
    document.getElementById('selected_item_id').value = itemId;
    document.getElementById('item_search').value = title;
    document.getElementById('item_results').style.display = 'none';
    
    // Show selected item
    const searchDiv = document.getElementById('item_search').parentElement.parentElement;
    searchDiv.innerHTML = `
        <label class="form-label fw-bold">Selected Item</label>
        <div class="card bg-light border-0 p-3">
            <div class="d-flex align-items-center">
                <div class="bg-secondary rounded d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                    <i class="fas fa-image text-white"></i>
                </div>
                <div>
                    <h6 class="mb-1">${title}</h6>
                    <p class="text-muted mb-0 small">${description.substring(0, 100)}...</p>
                    <small class="text-muted">by ${organizationName}</small>
                </div>
            </div>
        </div>
        <input type="hidden" name="item_id" value="${itemId}">
    `;
}

function showAlert(type, message) {
    const alertClass = type === 'success' ? 'alert-success' : type === 'warning' ? 'alert-warning' : 'alert-danger';
    const alert = document.createElement('div');
    alert.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    alert.style.top = '20px';
    alert.style.right = '20px';
    alert.style.zIndex = '9999';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alert);
    
    setTimeout(() => alert.remove(), 5000);
}
</script>
{% endblock %}
