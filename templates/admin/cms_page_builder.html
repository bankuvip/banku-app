{% extends "base.html" %}

{% block title %}Page Builder - {{ page.title }} - BankU{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2 mb-0">
                    <i class="fas fa-puzzle-piece me-2"></i>Page Builder - {{ page.title }}
                </h1>
                <div class="btn-group">
                    <a href="{{ url_for('admin.cms_view_page', page_id=page.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Page
                    </a>
                    <a href="{{ url_for('admin.cms_page_preview', page_id=page.id) }}" class="btn btn-outline-primary" target="_blank">
                        <i class="fas fa-eye me-2"></i>Preview
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Widget Library -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">Widget Library</h5>
                </div>
                <div class="card-body p-0">
                    <div class="widget-categories">
                        <!-- Dashboard Widgets -->
                        <div class="widget-category mb-3">
                            <h6 class="text-primary mb-2">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </h6>
                            <div class="widget-list">
                                <div class="widget-item" data-widget-type="stats_card" data-category="dashboard">
                                    <i class="fas fa-chart-bar me-2"></i>Stats Card
                                </div>
                                <div class="widget-item" data-widget-type="chart" data-category="dashboard">
                                    <i class="fas fa-chart-line me-2"></i>Chart
                                </div>
                                <div class="widget-item" data-widget-type="recent_activity" data-category="dashboard">
                                    <i class="fas fa-clock me-2"></i>Recent Activity
                                </div>
                                <div class="widget-item" data-widget-type="quick_actions" data-category="dashboard">
                                    <i class="fas fa-bolt me-2"></i>Quick Actions
                                </div>
                            </div>
                        </div>

                        <!-- Banks Widgets -->
                        <div class="widget-category mb-3">
                            <h6 class="text-success mb-2">
                                <i class="fas fa-university me-2"></i>Banks
                            </h6>
                            <div class="widget-list">
                                <div class="widget-item" data-widget-type="bank_stats" data-category="banks">
                                    <i class="fas fa-chart-pie me-2"></i>Bank Statistics
                                </div>
                                <div class="widget-item" data-widget-type="item_grid" data-category="banks">
                                    <i class="fas fa-th me-2"></i>Item Grid
                                </div>
                                <div class="widget-item" data-widget-type="category_filter" data-category="banks">
                                    <i class="fas fa-filter me-2"></i>Category Filter
                                </div>
                                <div class="widget-item" data-widget-type="search_bar" data-category="banks">
                                    <i class="fas fa-search me-2"></i>Search Bar
                                </div>
                            </div>
                        </div>

                        <!-- Content Widgets -->
                        <div class="widget-category mb-3">
                            <h6 class="text-info mb-2">
                                <i class="fas fa-edit me-2"></i>Content
                            </h6>
                            <div class="widget-list">
                                <div class="widget-item" data-widget-type="text_block" data-category="content">
                                    <i class="fas fa-paragraph me-2"></i>Text Block
                                </div>
                                <div class="widget-item" data-widget-type="image_gallery" data-category="content">
                                    <i class="fas fa-images me-2"></i>Image Gallery
                                </div>
                                <div class="widget-item" data-widget-type="video_player" data-category="content">
                                    <i class="fas fa-play-circle me-2"></i>Video Player
                                </div>
                                <div class="widget-item" data-widget-type="contact_form" data-category="content">
                                    <i class="fas fa-envelope me-2"></i>Contact Form
                                </div>
                            </div>
                        </div>

                        <!-- Data Widgets -->
                        <div class="widget-category mb-3">
                            <h6 class="text-warning mb-2">
                                <i class="fas fa-database me-2"></i>Data
                            </h6>
                            <div class="widget-list">
                                <div class="widget-item" data-widget-type="data_table" data-category="data">
                                    <i class="fas fa-table me-2"></i>Data Table
                                </div>
                                <div class="widget-item" data-widget-type="user_list" data-category="data">
                                    <i class="fas fa-users me-2"></i>User List
                                </div>
                                <div class="widget-item" data-widget-type="deals_list" data-category="data">
                                    <i class="fas fa-university me-2"></i>Deals List
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page Canvas -->
        <div class="col-md-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">Page Canvas</h5>
                </div>
                <div class="card-body">
                    <div id="pageCanvas" class="page-canvas">
                        <!-- Header Area -->
                        <div class="canvas-area" data-position="header">
                            <div class="area-label">Header</div>
                            <div class="widget-drop-zone" data-position="header">
                                <div class="drop-zone-placeholder">
                                    <i class="fas fa-plus"></i>
                                    <span>Drop widgets here</span>
                                </div>
                            </div>
                        </div>

                        <!-- Main Content Area -->
                        <div class="canvas-area" data-position="main">
                            <div class="area-label">Main Content</div>
                            <div class="widget-drop-zone" data-position="main">
                                <div class="drop-zone-placeholder">
                                    <i class="fas fa-plus"></i>
                                    <span>Drop widgets here</span>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar Area -->
                        <div class="canvas-area" data-position="sidebar">
                            <div class="area-label">Sidebar</div>
                            <div class="widget-drop-zone" data-position="sidebar">
                                <div class="drop-zone-placeholder">
                                    <i class="fas fa-plus"></i>
                                    <span>Drop widgets here</span>
                                </div>
                            </div>
                        </div>

                        <!-- Footer Area -->
                        <div class="canvas-area" data-position="footer">
                            <div class="area-label">Footer</div>
                            <div class="widget-drop-zone" data-position="footer">
                                <div class="drop-zone-placeholder">
                                    <i class="fas fa-plus"></i>
                                    <span>Drop widgets here</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget Properties -->
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">Widget Properties</h5>
                </div>
                <div class="card-body">
                    <div id="widgetProperties">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-cog fa-2x mb-2"></i>
                            <p>Select a widget to edit its properties</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Widget Configuration Modal -->
<div class="modal fade" id="widgetConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configure Widget</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="widgetConfigContent">
                <!-- Widget configuration form will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveWidgetConfig">Save Widget</button>
            </div>
        </div>
    </div>
</div>

<style>
.widget-item {
    padding: 8px 12px;
    margin: 2px 0;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    cursor: grab;
    transition: all 0.2s;
}

.widget-item:hover {
    background: #e9ecef;
    border-color: #007bff;
}

.widget-item:active {
    cursor: grabbing;
}

.canvas-area {
    margin: 10px 0;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    min-height: 100px;
    position: relative;
}

.area-label {
    position: absolute;
    top: -10px;
    left: 10px;
    background: white;
    padding: 0 8px;
    font-size: 12px;
    color: #6c757d;
    font-weight: 500;
}

.widget-drop-zone {
    min-height: 80px;
    padding: 20px;
}

.drop-zone-placeholder {
    text-align: center;
    color: #6c757d;
    padding: 20px;
}

.drop-zone-placeholder i {
    font-size: 24px;
    margin-bottom: 8px;
    display: block;
}

.widget-instance {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    margin: 5px 0;
    position: relative;
}

.widget-instance:hover {
    border-color: #007bff;
}

.widget-instance .widget-controls {
    position: absolute;
    top: 5px;
    right: 5px;
    opacity: 0;
    transition: opacity 0.2s;
}

.widget-instance:hover .widget-controls {
    opacity: 1;
}

.widget-controls .btn {
    padding: 2px 6px;
    font-size: 12px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pageId = {{ page.id }};
    let draggedWidget = null;
    let selectedWidget = null;

    // Load existing widgets
    loadWidgets();

    // Make widget items draggable
    document.querySelectorAll('.widget-item').forEach(item => {
        item.draggable = true;
        
        item.addEventListener('dragstart', function(e) {
            draggedWidget = {
                type: this.dataset.widgetType,
                category: this.dataset.category
            };
            e.dataTransfer.effectAllowed = 'copy';
        });
    });

    // Make drop zones droppable
    document.querySelectorAll('.widget-drop-zone').forEach(zone => {
        zone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            this.classList.add('drag-over');
        });

        zone.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });

        zone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedWidget) {
                const position = this.dataset.position;
                addWidget(draggedWidget.type, position);
                draggedWidget = null;
            }
        });
    });

    function loadWidgets() {
        fetch(`/admin/cms/pages/${pageId}/widgets`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderWidgets(data.widgets);
                }
            })
            .catch(error => {
                console.error('Error loading widgets:', error);
            });
    }

    function renderWidgets(widgets) {
        // Clear existing widgets
        document.querySelectorAll('.widget-drop-zone').forEach(zone => {
            const placeholder = zone.querySelector('.drop-zone-placeholder');
            if (placeholder) {
                placeholder.style.display = 'none';
            }
        });

        // Render widgets
        widgets.forEach(widget => {
            const zone = document.querySelector(`[data-position="${widget.position}"]`);
            if (zone) {
                const widgetElement = createWidgetElement(widget);
                zone.appendChild(widgetElement);
            }
        });
    }

    function createWidgetElement(widget) {
        const div = document.createElement('div');
        div.className = 'widget-instance';
        div.dataset.widgetId = widget.id;
        div.dataset.widgetType = widget.widget_type;
        
        div.innerHTML = `
            <div class="widget-controls">
                <button class="btn btn-sm btn-outline-primary" onclick="editWidget(${widget.id})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteWidget(${widget.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="widget-preview">
                ${getWidgetPreview(widget.widget_type, widget.widget_config)}
            </div>
        `;

        div.addEventListener('click', function() {
            selectWidget(widget.id);
        });

        return div;
    }

    function getWidgetPreview(type, config) {
        switch(type) {
            case 'stats_card':
                return `<div class="d-flex align-items-center">
                    <i class="fas fa-chart-bar text-primary me-2"></i>
                    <div>
                        <div class="fw-bold">${config.title || 'Stats Card'}</div>
                        <small class="text-muted">${config.value || '0'}</small>
                    </div>
                </div>`;
            case 'chart':
                return `<div class="text-center">
                    <i class="fas fa-chart-line text-success me-2"></i>
                    <span>Chart Widget</span>
                </div>`;
            case 'text_block':
                return `<div>
                    <strong>${config.title || 'Text Block'}</strong>
                    <p class="mb-0">${config.content || 'Add your content here...'}</p>
                </div>`;
            default:
                return `<div class="text-center">
                    <i class="fas fa-puzzle-piece text-muted me-2"></i>
                    <span>${type.replace('_', ' ').toUpperCase()}</span>
                </div>`;
        }
    }

    function addWidget(type, position) {
        const config = getDefaultConfig(type);
        
        fetch(`/admin/cms/pages/${pageId}/widgets`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                widget_type: type,
                widget_config: config,
                position: position,
                sort_order: 0,
                is_published: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadWidgets();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error adding widget:', error);
            alert('An error occurred while adding the widget.');
        });
    }

    function getDefaultConfig(type) {
        const configs = {
            'stats_card': {
                title: 'New Stats Card',
                value: '0',
                icon: 'fas fa-chart-bar',
                color: 'primary'
            },
            'chart': {
                title: 'New Chart',
                type: 'line',
                data: []
            },
            'text_block': {
                title: 'New Text Block',
                content: 'Add your content here...'
            },
            'bank_stats': {
                title: 'Bank Statistics',
                show_categories: true
            },
            'item_grid': {
                title: 'Items Grid',
                items_per_page: 12,
                show_filters: true
            }
        };
        
        return configs[type] || {};
    }

    function selectWidget(widgetId) {
        selectedWidget = widgetId;
        // Update UI to show selected widget
        document.querySelectorAll('.widget-instance').forEach(w => {
            w.classList.remove('selected');
        });
        document.querySelector(`[data-widget-id="${widgetId}"]`).classList.add('selected');
        
        // Load widget properties
        loadWidgetProperties(widgetId);
    }

    function loadWidgetProperties(widgetId) {
        // This would load the widget properties panel
        document.getElementById('widgetProperties').innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-cog fa-2x mb-2"></i>
                <p>Widget ${widgetId} selected</p>
                <button class="btn btn-primary btn-sm" onclick="editWidget(${widgetId})">
                    <i class="fas fa-edit me-2"></i>Edit Widget
                </button>
            </div>
        `;
    }

    function editWidget(widgetId) {
        // Open widget configuration modal
        new bootstrap.Modal(document.getElementById('widgetConfigModal')).show();
        // Load widget configuration form
        loadWidgetConfigForm(widgetId);
    }

    function loadWidgetConfigForm(widgetId) {
        // This would load the appropriate configuration form based on widget type
        document.getElementById('widgetConfigContent').innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p>Loading widget configuration...</p>
            </div>
        `;
    }

    function deleteWidget(widgetId) {
        if (confirm('Are you sure you want to delete this widget?')) {
            fetch(`/admin/cms/pages/${pageId}/widgets/${widgetId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadWidgets();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error deleting widget:', error);
                alert('An error occurred while deleting the widget.');
            });
        }
    }

    // Make functions global
    window.editWidget = editWidget;
    window.deleteWidget = deleteWidget;
});
</script>
{% endblock %}




