{% extends "base.html" %}

{% block title %}{{ collector.name }} - Collected Data{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-robot me-2"></i>{{ collector.name }}</h2>
                    <p class="text-muted mb-0">{{ collector.description }}</p>
                </div>
                <div>
                    <a href="{{ url_for('admin.data_collectors') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Collectors
                    </a>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addToBankModal">
                        <i class="fas fa-plus me-2"></i>Add to Bank
                    </button>
                    <a href="{{ url_for('admin.edit_data_collector', collector_id=collector.id) }}" class="btn btn-primary">
                        <i class="fas fa-edit me-2"></i>Edit Collector
                    </a>
                </div>
            </div>
            
            <!-- Collector Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ collector.success_count }}</h4>
                                    <p class="mb-0">Successful Runs</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ collector.error_count }}</h4>
                                    <p class="mb-0">Failed Runs</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-exclamation-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ collected_items|length + collected_organizations|length }}</h4>
                                    <p class="mb-0">Items Collected</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-database fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="mb-0">{{ collector.data_type.title() }}</h4>
                                    <p class="mb-0">Data Type</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-tag fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collector Configuration -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-cog me-2"></i>Collector Configuration
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Basic Information</h6>
                                    <ul class="list-unstyled">
                                        <li><strong>Name:</strong> {{ collector.name }}</li>
                                        <li><strong>Type:</strong> {{ collector.data_type.title() }}</li>
                                        <li><strong>Status:</strong> 
                                            <span class="badge bg-{{ 'success' if collector.is_active else 'secondary' }}">
                                                {{ 'Active' if collector.is_active else 'Inactive' }}
                                            </span>
                                        </li>
                                        <li><strong>Created:</strong> {{ collector.created_at.strftime('%Y-%m-%d %H:%M') if collector.created_at else 'Unknown' }}</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Website Configuration</h6>
                                    {% if collector.filter_rules and collector.filter_rules.url %}
                                        <ul class="list-unstyled">
                                            <li><strong>URL:</strong> 
                                                <a href="{{ collector.filter_rules.url }}" target="_blank" class="text-decoration-none">
                                                    {{ collector.filter_rules.url[:50] }}{% if collector.filter_rules.url|length > 50 %}...{% endif %}
                                                </a>
                                            </li>
                                            <li><strong>Selenium:</strong> {{ 'Yes' if collector.filter_rules.use_selenium else 'No' }}</li>
                                            <li><strong>Selectors:</strong> {{ collector.filter_rules.selectors|length if collector.filter_rules.selectors else 0 }}</li>
                                        </ul>
                                    {% else %}
                                        <p class="text-muted">Internal collector (no web scraping)</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Collected Data Tabs -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="dataTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab">
                                        <i class="fas fa-box me-1"></i>Items ({{ collected_items|length }})
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="organizations-tab" data-bs-toggle="tab" data-bs-target="#organizations" type="button" role="tab">
                                        <i class="fas fa-building me-1"></i>Organizations ({{ collected_organizations|length }})
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="responses-tab" data-bs-toggle="tab" data-bs-target="#responses" type="button" role="tab">
                                        <i class="fas fa-comments me-1"></i>Chatbot Responses ({{ chatbot_responses|length }})
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests" type="button" role="tab">
                                        <i class="fas fa-vial me-1"></i>Test Results ({{ recent_tests|length }})
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content" id="dataTabsContent">
                                <!-- Items Tab -->
                                <div class="tab-pane fade show active" id="items" role="tabpanel">
                                    {% if collected_items %}
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Title</th>
                                                        <th>Category</th>
                                                        <th>Price</th>
                                                        <th>Location</th>
                                                        <th>Created</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for item in collected_items %}
                                                    <tr>
                                                        <td>{{ item.id }}</td>
                                                        <td>{{ item.title }}</td>
                                                        <td><span class="badge bg-secondary">{{ item.category }}</span></td>
                                                        <td>{{ item.price if item.price else 'N/A' }}</td>
                                                        <td>{{ item.location if item.location else 'N/A' }}</td>
                                                        <td>{{ item.created_at.strftime('%Y-%m-%d %H:%M') if item.created_at else 'Unknown' }}</td>
                                                        <td>
                                                            <div class="btn-group" role="group">
                                                                <a href="{{ url_for('banks.item_detail', item_id=item.id) }}" class="btn btn-sm btn-outline-primary" title="View">
                                                                    <i class="fas fa-eye"></i>
                                                                </a>
                                                                <button type="button" class="btn btn-sm btn-outline-success" title="Add to Bank" onclick="addItemToBank({{ item.id }}, '{{ item.title }}', 'item')">
                                                                    <i class="fas fa-plus"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center py-4">
                                            <i class="fas fa-box fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">No Items Collected Yet</h5>
                                            <p class="text-muted">This collector hasn't created any items yet.</p>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Organizations Tab -->
                                <div class="tab-pane fade" id="organizations" role="tabpanel">
                                    {% if collected_organizations %}
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Name</th>
                                                        <th>Type</th>
                                                        <th>Email</th>
                                                        <th>Phone</th>
                                                        <th>Created</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for org in collected_organizations %}
                                                    <tr>
                                                        <td>{{ org.id }}</td>
                                                        <td>{{ org.name }}</td>
                                                        <td><span class="badge bg-info">{{ org.organization_type.name if org.organization_type else 'Unknown' }}</span></td>
                                                        <td>{{ org.contact_email if org.contact_email else 'N/A' }}</td>
                                                        <td>{{ org.contact_phone if org.contact_phone else 'N/A' }}</td>
                                                        <td>{{ org.created_at.strftime('%Y-%m-%d %H:%M') if org.created_at else 'Unknown' }}</td>
                                                        <td>
                                                            <div class="btn-group" role="group">
                                                                <a href="{{ url_for('organizations.view', slug=org.slug) }}" class="btn btn-sm btn-outline-primary" title="View">
                                                                    <i class="fas fa-eye"></i>
                                                                </a>
                                                                <button type="button" class="btn btn-sm btn-outline-success" title="Add to Bank" onclick="addItemToBank({{ org.id }}, '{{ org.name }}', 'organization')">
                                                                    <i class="fas fa-plus"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center py-4">
                                            <i class="fas fa-building fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">No Organizations Collected Yet</h5>
                                            <p class="text-muted">This collector hasn't created any organizations yet.</p>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Chatbot Responses Tab -->
                                <div class="tab-pane fade" id="responses" role="tabpanel">
                                    {% if chatbot_responses %}
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Session ID</th>
                                                        <th>Flow ID</th>
                                                        <th>Completed</th>
                                                        <th>Created</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for response in chatbot_responses %}
                                                    <tr>
                                                        <td>{{ response.id }}</td>
                                                        <td><code>{{ response.session_id[:20] }}...</code></td>
                                                        <td>{{ response.flow_id }}</td>
                                                        <td>
                                                            <span class="badge bg-{{ 'success' if response.completed else 'warning' }}">
                                                                {{ 'Yes' if response.completed else 'No' }}
                                                            </span>
                                                        </td>
                                                        <td>{{ response.created_at.strftime('%Y-%m-%d %H:%M') if response.created_at else 'Unknown' }}</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-info" onclick="viewResponse({{ response.id }})">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center py-4">
                                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">No Chatbot Responses Yet</h5>
                                            <p class="text-muted">This collector hasn't generated any chatbot responses yet.</p>
                                        </div>
                                    {% endif %}
                                </div>

                                <!-- Test Results Tab -->
                                <div class="tab-pane fade" id="tests" role="tabpanel">
                                    {% if recent_tests %}
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Timestamp</th>
                                                        <th>Status</th>
                                                        <th>Items Found</th>
                                                        <th>Message</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for test in recent_tests %}
                                                    <tr>
                                                        <td>{{ test.timestamp.strftime('%Y-%m-%d %H:%M:%S') if test.timestamp else 'Unknown' }}</td>
                                                        <td>
                                                            <span class="badge bg-{{ 'success' if test.status == 'success' else 'danger' }}">
                                                                {{ test.status.title() }}
                                                            </span>
                                                        </td>
                                                        <td>{{ test.items_found }}</td>
                                                        <td>{{ test.message }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="text-center py-4">
                                            <i class="fas fa-vial fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted">No Test Results Yet</h5>
                                            <p class="text-muted">This collector hasn't been tested yet.</p>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Response Modal -->
<div class="modal fade" id="responseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chatbot Response Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="responseData" class="bg-light p-3 rounded"></pre>
            </div>
        </div>
    </div>
</div>

<!-- Add Individual Item to Bank Modal -->
<div class="modal fade" id="addItemToBankModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add Item to Bank
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Add <strong id="itemName"></strong> to a bank.
                </div>
                
                <form id="addItemToBankForm">
                    <input type="hidden" id="itemId" name="item_id">
                    <input type="hidden" id="itemType" name="item_type">
                    
                    <div class="mb-3">
                        <label for="bankSelectItem" class="form-label">Select Bank</label>
                        <select class="form-select" id="bankSelectItem" name="bank_id" required>
                            <option value="">Choose a bank...</option>
                            <!-- Banks will be populated by JavaScript -->
                        </select>
                        <div class="form-text">Choose which bank to add this item to</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirmAddItem" required>
                            <label class="form-check-label" for="confirmAddItem">
                                I confirm that I want to add this item to the selected bank
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="addItemToBankBtn" disabled>
                    <i class="fas fa-plus me-2"></i>Add to Bank
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add to Bank Modal -->
<div class="modal fade" id="addToBankModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add Collected Data to Bank
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This will add all collected data from <strong>{{ collector.name }}</strong> to the selected bank.
                </div>
                
                <form id="addToBankForm">
                    <div class="mb-3">
                        <label for="bankSelect" class="form-label">Select Bank</label>
                        <select class="form-select" id="bankSelect" name="bank_id" required>
                            <option value="">Choose a bank...</option>
                            <!-- Banks will be populated by JavaScript -->
                        </select>
                        <div class="form-text">Choose which bank to add the collected data to</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Data Summary</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">{{ collected_items|length }}</h5>
                                        <p class="card-text">Items</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">{{ collected_organizations|length }}</h5>
                                        <p class="card-text">Organizations</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirmAdd" required>
                            <label class="form-check-label" for="confirmAdd">
                                I confirm that I want to add this data to the selected bank
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="addToBankBtn" disabled>
                    <i class="fas fa-plus me-2"></i>Add to Bank
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function viewResponse(responseId) {
    // This would typically fetch the response data via AJAX
    // For now, we'll show a placeholder
    document.getElementById('responseData').textContent = 'Response data for ID: ' + responseId;
    new bootstrap.Modal(document.getElementById('responseModal')).show();
}

// Add Individual Item to Bank functionality
function addItemToBank(itemId, itemName, itemType) {
    document.getElementById('itemId').value = itemId;
    document.getElementById('itemType').value = itemType;
    document.getElementById('itemName').textContent = itemName;
    
    // Reset form
    document.getElementById('bankSelectItem').value = '';
    document.getElementById('confirmAddItem').checked = false;
    document.getElementById('addItemToBankBtn').disabled = true;
    
    // Show modal
    new bootstrap.Modal(document.getElementById('addItemToBankModal')).show();
}

// Add to Bank functionality
document.addEventListener('DOMContentLoaded', function() {
    const bankSelect = document.getElementById('bankSelect');
    const confirmCheckbox = document.getElementById('confirmAdd');
    const addToBankBtn = document.getElementById('addToBankBtn');
    
    // Individual item bank selection
    const bankSelectItem = document.getElementById('bankSelectItem');
    const confirmAddItem = document.getElementById('confirmAddItem');
    const addItemToBankBtn = document.getElementById('addItemToBankBtn');
    
    // Load banks for both dropdowns
    fetch('/admin/banks/api/list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                data.banks.forEach(bank => {
                    // Add to main dropdown
                    const option = document.createElement('option');
                    option.value = bank.id;
                    option.textContent = `${bank.name} (${bank.bank_type})`;
                    bankSelect.appendChild(option);
                    
                    // Add to individual item dropdown
                    const optionItem = document.createElement('option');
                    optionItem.value = bank.id;
                    optionItem.textContent = `${bank.name} (${bank.bank_type})`;
                    bankSelectItem.appendChild(optionItem);
                });
            }
        })
        .catch(error => {
            console.error('Error loading banks:', error);
            bankSelect.innerHTML = '<option value="">Error loading banks</option>';
            bankSelectItem.innerHTML = '<option value="">Error loading banks</option>';
        });
    
    // Enable/disable add button based on form completion
    function updateAddButton() {
        const bankSelected = bankSelect.value !== '';
        const confirmed = confirmCheckbox.checked;
        addToBankBtn.disabled = !(bankSelected && confirmed);
    }
    
    bankSelect.addEventListener('change', updateAddButton);
    confirmCheckbox.addEventListener('change', updateAddButton);
    
    // Individual item functionality
    function updateAddItemButton() {
        const bankSelected = bankSelectItem.value !== '';
        const confirmed = confirmAddItem.checked;
        addItemToBankBtn.disabled = !(bankSelected && confirmed);
    }
    
    bankSelectItem.addEventListener('change', updateAddItemButton);
    confirmAddItem.addEventListener('change', updateAddItemButton);
    
    // Handle add to bank
    addToBankBtn.addEventListener('click', function() {
        if (!addToBankBtn.disabled) {
            const formData = new FormData();
            formData.append('bank_id', bankSelect.value);
            formData.append('collector_id', '{{ collector.id }}');
            
            fetch('/admin/data-collectors/{{ collector.id }}/add-to-bank', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Data successfully added to bank!');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding data to bank');
            });
        }
    });
    
    // Handle add individual item to bank
    addItemToBankBtn.addEventListener('click', function() {
        if (!addItemToBankBtn.disabled) {
            const formData = new FormData();
            formData.append('bank_id', bankSelectItem.value);
            formData.append('item_id', document.getElementById('itemId').value);
            formData.append('item_type', document.getElementById('itemType').value);
            
            fetch('/admin/data-collectors/add-item-to-bank', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Item successfully added to bank!');
                    bootstrap.Modal.getInstance(document.getElementById('addItemToBankModal')).hide();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding item to bank');
            });
        }
    });
});
</script>
{% endblock %}
