{% extends "base.html" %}

{% block title %}{{ step_block.name }} - Questions - BankU{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2 mb-0">
                    <i class="fas fa-question-circle me-2"></i>{{ step_block.name }} - Questions
                </h1>
                <div class="btn-group">
                    <a href="{{ url_for('admin.chatbot_step_blocks', flow_id=flow.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Step Blocks
                    </a>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuestionModal">
                        <i class="fas fa-plus me-2"></i>Add Question
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step Block Info -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title">{{ step_block.name }}</h5>
                            <p class="text-muted">{{ step_block.description or 'No description provided' }}</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="d-flex justify-content-end gap-2">
                                <span class="badge bg-{% if step_block.is_required %}danger{% else %}secondary{% endif %}">
                                    {% if step_block.is_required %}Required{% else %}Optional{% endif %}
                                </span>
                                <span class="badge bg-info">{{ questions|length }} Questions</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Questions List -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <h5 class="card-title mb-0">Questions in this Step</h5>
                </div>
                <div class="card-body p-0">
                    {% if questions %}
                        <div class="questions-list">
                            {% for question in questions %}
                            <div class="question-item" data-question-id="{{ question.id }}">
                                <div class="question-header">
                                    <div class="question-info">
                                        <div class="question-number">{{ question.order_index }}</div>
                                        <div class="question-details">
                                            <h6 class="question-title">{{ question.question_text }}</h6>
                                            <div class="question-meta">
                                                <span class="badge bg-primary">{{ question.question_type|title }}</span>
                                                {% if question.is_required %}
                                                <span class="badge bg-danger">Required</span>
                                                {% else %}
                                                <span class="badge bg-secondary">Optional</span>
                                                {% endif %}
                                                {% if question.placeholder %}
                                                <span class="badge bg-light text-dark">Placeholder: {{ question.placeholder }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="question-actions">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" 
                                                    class="btn btn-outline-warning btn-sm move-question" 
                                                    data-question-id="{{ question.id }}" 
                                                    title="Move Up/Down">
                                                <i class="fas fa-arrows-alt-v"></i>
                                            </button>
                                            <button type="button" 
                                                    class="btn btn-outline-secondary btn-sm edit-question" 
                                                    data-question-id="{{ question.id }}" 
                                                    title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" 
                                                    class="btn btn-outline-danger btn-sm delete-question" 
                                                    data-question-id="{{ question.id }}" 
                                                    data-question-text="{{ question.question_text }}"
                                                    title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Question Options Preview -->
                                {% if question.options %}
                                <div class="question-options">
                                    <strong>Options:</strong>
                                    <ul class="list-unstyled mb-0">
                                        {% for option in question.options %}
                                        <li><i class="fas fa-circle text-muted me-2" style="font-size: 6px;"></i>{{ option }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                                
                                {% if question.help_text %}
                                <div class="question-help">
                                    <i class="fas fa-info-circle text-info me-2"></i>
                                    <span class="text-muted">{{ question.help_text }}</span>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-question-circle text-muted" style="font-size: 3rem;"></i>
                            <h5 class="text-muted mt-3">No Questions Yet</h5>
                            <p class="text-muted">Add questions to this step block to start building your chatbot flow.</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addQuestionModal">
                                <i class="fas fa-plus me-2"></i>Add First Question
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Question Modal -->
<div class="modal fade" id="addQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Question to {{ step_block.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addQuestionForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="questionText" class="form-label">Question Text *</label>
                                <textarea class="form-control" id="questionText" name="question_text" rows="3" required 
                                          placeholder="What is your full name?"></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="questionType" class="form-label">Question Type *</label>
                                <select class="form-select" id="questionType" name="question_type" required>
                                    <option value="">Select question type</option>
                                    <option value="text">Text Input</option>
                                    <option value="email">Email</option>
                                    <option value="phone">Phone Number</option>
                                    <option value="number">Number</option>
                                    <option value="date">Date</option>
                                    <option value="select">Dropdown</option>
                                    <option value="radio">Radio Buttons</option>
                                    <option value="checkbox">Checkboxes</option>
                                    <option value="textarea">Long Text</option>
                                </select>
                            </div>
                            
                            <div class="mb-3" id="optionsContainer" style="display: none;">
                                <label for="questionOptions" class="form-label">Options</label>
                                <div id="optionsList">
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control option-input" placeholder="Option 1">
                                        <button type="button" class="btn btn-outline-danger remove-option">Remove</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="addOption">
                                    <i class="fas fa-plus me-2"></i>Add Option
                                </button>
                            </div>
                            
                            <div class="mb-3">
                                <label for="placeholder" class="form-label">Placeholder Text</label>
                                <input type="text" class="form-control" id="placeholder" name="placeholder" 
                                       placeholder="Enter your answer here...">
                            </div>
                            
                            <div class="mb-3">
                                <label for="helpText" class="form-label">Help Text</label>
                                <textarea class="form-control" id="helpText" name="help_text" rows="2" 
                                          placeholder="Additional information to help users answer..."></textarea>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="card-title mb-0">Question Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="isRequired" name="is_required" checked>
                                            <label class="form-check-label" for="isRequired">
                                                Required Question
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="validationRules" class="form-label">Validation Rules</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="minLength" name="min_length">
                                            <label class="form-check-label" for="minLength">
                                                Minimum Length
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="maxLength" name="max_length">
                                            <label class="form-check-label" for="maxLength">
                                                Maximum Length
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveQuestion">Add Question</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this question?</p>
                <p class="text-danger"><strong id="deleteQuestionText"></strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<style>
.question-item {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin: 15px;
    background: white;
    transition: all 0.2s;
}

.question-item:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: #007bff;
}

.question-header {
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border-bottom: 1px solid #f8f9fa;
}

.question-info {
    display: flex;
    align-items: flex-start;
    flex: 1;
}

.question-number {
    width: 35px;
    height: 35px;
    background: #28a745;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 15px;
    flex-shrink: 0;
    font-size: 14px;
}

.question-details {
    flex: 1;
}

.question-title {
    margin: 0 0 10px 0;
    color: #212529;
    font-size: 16px;
}

.question-meta {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.question-actions {
    margin-left: 15px;
}

.question-options {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
}

.question-help {
    padding: 10px 20px;
    background: #e7f3ff;
    border-top: 1px solid #b3d9ff;
    font-size: 14px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionTypeSelect = document.getElementById('questionType');
    const optionsContainer = document.getElementById('optionsContainer');
    const optionsList = document.getElementById('optionsList');
    const addOptionBtn = document.getElementById('addOption');
    const saveQuestionBtn = document.getElementById('saveQuestion');
    
    // Show/hide options based on question type
    questionTypeSelect.addEventListener('change', function() {
        const needsOptions = ['select', 'radio', 'checkbox'].includes(this.value);
        optionsContainer.style.display = needsOptions ? 'block' : 'none';
    });
    
    // Add option functionality
    addOptionBtn.addEventListener('click', function() {
        const optionCount = optionsList.children.length;
        const optionDiv = document.createElement('div');
        optionDiv.className = 'input-group mb-2';
        optionDiv.innerHTML = `
            <input type="text" class="form-control option-input" placeholder="Option ${optionCount + 1}">
            <button type="button" class="btn btn-outline-danger remove-option">Remove</button>
        `;
        optionsList.appendChild(optionDiv);
    });
    
    // Remove option functionality
    optionsList.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-option')) {
            e.target.parentElement.remove();
        }
    });
    
    // Save question
    saveQuestionBtn.addEventListener('click', function() {
        const formData = new FormData(document.getElementById('addQuestionForm'));
        const options = Array.from(document.querySelectorAll('.option-input')).map(input => input.value).filter(val => val.trim());
        
        const data = {
            question_text: formData.get('question_text'),
            question_type: formData.get('question_type'),
            options: options.length > 0 ? options : null,
            is_required: formData.get('is_required') === 'on',
            placeholder: formData.get('placeholder'),
            help_text: formData.get('help_text'),
            validation_rules: {},
            conditional_logic: {}
        };
        
        fetch('/admin/chatbots/{{ flow.id }}/step-blocks/{{ step_block.id }}/questions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the question.');
        });
    });
    
    // Delete question functionality
    let deleteQuestionId = null;
    
    document.querySelectorAll('.delete-question').forEach(btn => {
        btn.addEventListener('click', function() {
            deleteQuestionId = this.dataset.questionId;
            document.getElementById('deleteQuestionText').textContent = this.dataset.questionText;
            new bootstrap.Modal(document.getElementById('deleteModal')).show();
        });
    });

    document.getElementById('confirmDelete').addEventListener('click', function() {
        if (deleteQuestionId) {
            // Implement delete functionality here
            alert('Delete functionality coming soon!');
        }
    });
});
</script>
{% endblock %}




