<!DOCTYPE html>
<html>
<head>
    <title>Simple Chatbot Creator - Fixed Branching</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Simple Chatbot Creator (Fixed Branching)</h1>
        
        <form id="chatbotForm">
            <div class="mb-3">
                <label class="form-label">Chatbot Name</label>
                <input type="text" class="form-control" id="chatbotName" required>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="chatbotDescription"></textarea>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5>Step 1</h5>
                </div>
                <div class="card-body">
                    <div id="questionsContainer">
                        <!-- Questions will be added here -->
                    </div>
                    <button type="button" class="btn btn-outline-primary" onclick="addQuestion()">
                        <i class="fas fa-plus"></i> Add Question
                    </button>
                </div>
            </div>
            
            <div class="mt-4">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="fas fa-save"></i> Create Chatbot
                </button>
            </div>
        </form>
    </div>

    <script>
        let questionCount = 0;
        
        function addQuestion() {
            questionCount++;
            const container = document.getElementById('questionsContainer');
            
            const questionHTML = `
                <div class="question-item border rounded p-3 mb-3" data-index="${questionCount - 1}">
                    <div class="row">
                        <div class="col-md-8">
                            <label class="form-label">Question ${questionCount}</label>
                            <input type="text" class="form-control question-text" placeholder="Enter your question">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Type</label>
                            <select class="form-select question-type">
                                <option value="text">Text Input</option>
                                <option value="select">Multiple Choice</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">Default View</label>
                            <select class="form-select default-view">
                                <option value="show">Show by Default</option>
                                <option value="hide">Hide by Default</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                <input class="form-check-input" type="checkbox" id="required${questionCount}">
                                <label class="form-check-label" for="required${questionCount}">Required</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="options-section mt-3" style="display: none;">
                        <label class="form-label">Options (one per line)</label>
                        <textarea class="form-control question-options" rows="3" placeholder="Option 1\nOption 2\nOption 3"></textarea>
                    </div>
                    
                    <div class="mt-3">
                        <div class="form-check">
                            <input class="form-check-input branching-enabled" type="checkbox" id="branching${questionCount}">
                            <label class="form-check-label" for="branching${questionCount}">
                                Enable Branching Rules
                            </label>
                        </div>
                        
                        <div class="branching-rules mt-3" style="display: none;">
                            <div class="branching-rules-container">
                                <!-- Rules will be added here -->
                            </div>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addBranchingRule(this.closest('.question-item'))">
                                <i class="fas fa-plus"></i> Add Rule
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeQuestion(this)">
                            <i class="fas fa-trash"></i> Remove Question
                        </button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', questionHTML);
            const newQuestion = container.lastElementChild;
            
            // Add event listeners
            setupQuestionEventListeners(newQuestion);
            
            console.log(`✅ Added Question ${questionCount}`);
        }
        
        function setupQuestionEventListeners(questionDiv) {
            const typeSelect = questionDiv.querySelector('.question-type');
            const optionsSection = questionDiv.querySelector('.options-section');
            const branchingCheckbox = questionDiv.querySelector('.branching-enabled');
            const branchingRules = questionDiv.querySelector('.branching-rules');
            
            // Show/hide options based on type
            typeSelect.addEventListener('change', function() {
                if (this.value === 'select') {
                    optionsSection.style.display = 'block';
                } else {
                    optionsSection.style.display = 'none';
                }
            });
            
            // Show/hide branching rules
            branchingCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    branchingRules.style.display = 'block';
                } else {
                    branchingRules.style.display = 'none';
                }
            });
        }
        
        function addBranchingRule(questionDiv) {
            console.log('🚀 ADDING SIMPLE BRANCHING RULE');
            
            const rulesContainer = questionDiv.querySelector('.branching-rules-container');
            
            const ruleHTML = `
                <div class="branching-rule border rounded p-2 mb-2">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label small">If Answer Is</label>
                            <input type="text" class="form-control form-control-sm rule-condition" placeholder="Yes">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small">Then</label>
                            <select class="form-select form-select-sm rule-action">
                                <option value="show_question">Show Question</option>
                                <option value="hide_question">Hide Question</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small">Target Question</label>
                            <select class="form-select form-select-sm rule-target">
                                <option value="">Select Question...</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small">&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm w-100 remove-rule">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            rulesContainer.insertAdjacentHTML('beforeend', ruleHTML);
            const newRule = rulesContainer.lastElementChild;
            
            // Populate target dropdown
            const targetSelect = newRule.querySelector('.rule-target');
            const allQuestions = document.querySelectorAll('.question-item');
            
            console.log(`🚀 Found ${allQuestions.length} questions`);
            
            allQuestions.forEach((q, index) => {
                const questionText = q.querySelector('.question-text').value || `Question ${index + 1}`;
                const option = document.createElement('option');
                option.value = index.toString();
                option.textContent = `${index + 1}. ${questionText}`;
                targetSelect.appendChild(option);
                console.log(`🚀 Added option: value="${index}", text="${index + 1}. ${questionText}"`);
            });
            
            console.log(`🚀 Target dropdown now has ${targetSelect.options.length} options`);
            for (let i = 0; i < targetSelect.options.length; i++) {
                console.log(`🚀 Option ${i}: value="${targetSelect.options[i].value}", text="${targetSelect.options[i].textContent}"`);
            }
            
            // Remove rule functionality
            newRule.querySelector('.remove-rule').addEventListener('click', function() {
                newRule.remove();
            });
            
            console.log(`🚀 RULE CREATED WITH ${targetSelect.options.length} OPTIONS`);
        }
        
        function removeQuestion(button) {
            button.closest('.question-item').remove();
        }
        
        // Form submission
        document.getElementById('chatbotForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('chatbotName').value;
            const description = document.getElementById('chatbotDescription').value;
            const questions = [];
            
            document.querySelectorAll('.question-item').forEach((q, index) => {
                const questionData = {
                    question_text: q.querySelector('.question-text').value,
                    question_type: q.querySelector('.question-type').value,
                    default_view: q.querySelector('.default-view').value,
                    is_required: q.querySelector('.form-check-input').checked,
                    order_index: index,
                    placeholder: '',
                    help_text: '',
                    validation_rules: {},
                    media_upload_config: {},
                    cascading_config: {},
                    number_unit_config: {}
                };
                
                // Add options if select type
                if (questionData.question_type === 'select') {
                    const optionsText = q.querySelector('.question-options').value;
                    questionData.options = optionsText.split('\n').filter(opt => opt.trim());
                }
                
                // Add branching rules
                const branchingEnabled = q.querySelector('.branching-enabled').checked;
                if (branchingEnabled) {
                    const rules = [];
                    q.querySelectorAll('.branching-rule').forEach(ruleDiv => {
                        const condition = ruleDiv.querySelector('.rule-condition').value.trim();
                        const action = ruleDiv.querySelector('.rule-action').value;
                        const target = ruleDiv.querySelector('.rule-target').value;
                        
                        console.log(`🚀 RULE DEBUG: condition="${condition}", action="${action}", target="${target}"`);
                        
                        if (condition && action && target) {
                            const rule = {
                                condition: condition,
                                action: action,
                                target: target, // This will be order_index for new chatbots
                                target_question_id: target, // Same as target
                                target_type: 'question',
                                target_order_index: target // Explicitly store order_index
                            };
                            console.log(`🚀 ADDING RULE:`, rule);
                            rules.push(rule);
                        } else {
                            console.log(`🚀 SKIPPING RULE: missing condition="${condition}", action="${action}", target="${target}"`);
                        }
                    });
                    
                    if (rules.length > 0) {
                        questionData.branching_logic = {
                            enabled: true,
                            rules: rules
                        };
                    }
                }
                
                questions.push(questionData);
            });
            
            const data = {
                name: name,
                description: description,
                flow_config: {},
                step_blocks: [{
                    name: "Step 1",
                    description: "Main step",
                    is_required: true,
                    step_order: 0,
                    questions: questions
                }]
            };
            
            console.log('🚀 SUBMITTING:', data);
            
            // Submit to server
            console.log('🚀 Submitting data:', JSON.stringify(data, null, 2));
            
            fetch('/admin/chatbots/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                console.log('🚀 Server response:', result);
                if (result.success) {
                    const chatbotId = result.chatbot_id || result.id;
                    const message = `✅ Chatbot created successfully!\n\n` +
                                  `🔗 Test it at: /chatbot/${chatbotId}\n` +
                                  `📝 Edit it at: /admin/chatbots/${chatbotId}/edit`;
                    
                    if (confirm(message + '\n\nGo to chatbot list now?')) {
                        window.location.href = '/admin/chatbots';
                    }
                } else {
                    alert('❌ Error: ' + (result.message || 'Unknown error'));
                    console.error('Server error:', result);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('❌ Error creating chatbot');
            });
        });
        
        // Add first question automatically
        addQuestion();
        addQuestion();
        
        console.log('🚀 SIMPLE CHATBOT CREATOR LOADED');
    </script>
</body>
</html>
