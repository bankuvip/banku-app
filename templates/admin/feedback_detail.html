{% extends "base.html" %}

{% block title %}Feedback #{{ feedback.id }} - BankU Admin{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">
                    <i class="fas fa-comment-dots me-2"></i>Feedback #{{ feedback.id }}
                </h2>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('feedback.admin_feedback') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to List
                    </a>
                    <button class="btn btn-primary" onclick="updateFeedbackStatus({{ feedback.id }}, '{{ feedback.status }}')">
                        <i class="fas fa-edit me-1"></i>Update Status
                    </button>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-8">
                    <!-- Main Content -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Feedback Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Subject:</strong>
                                    <p class="mb-0">{{ feedback.subject }}</p>
                                </div>
                                <div class="col-md-6">
                                    <strong>Type:</strong>
                                    <p class="mb-0">
                                        {% if feedback.type == 'suggestion' %}
                                            <span class="badge bg-info">üí° Suggestion</span>
                                        {% elif feedback.type == 'problem' %}
                                            <span class="badge bg-danger">üêõ Problem Report</span>
                                        {% elif feedback.type == 'request_deals' %}
                                            <span class="badge bg-success">ü§ù Request Make Deals</span>
                                        {% elif feedback.type == 'request_call' %}
                                            <span class="badge bg-warning">üìû Request Call</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ feedback.type }}</span>
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Message:</strong>
                                <div class="mt-2 p-3 bg-light rounded">
                                    {{ feedback.message | replace('\n', '<br>') | safe }}
                                </div>
                            </div>
                            
                            {% if feedback.admin_notes %}
                            <div class="mb-3">
                                <strong>Admin Notes:</strong>
                                <div class="mt-2 p-3 bg-info bg-opacity-10 rounded">
                                    {{ feedback.admin_notes | replace('\n', '<br>') | safe }}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Sidebar Info -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Feedback Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Status:</strong>
                                <div class="mt-1">
                                    {% if feedback.status == 'pending' %}
                                        <span class="badge bg-warning">Pending</span>
                                    {% elif feedback.status == 'in_progress' %}
                                        <span class="badge bg-info">In Progress</span>
                                    {% elif feedback.status == 'resolved' %}
                                        <span class="badge bg-success">Resolved</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Closed</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Priority:</strong>
                                <div class="mt-1">
                                    {% if feedback.priority == 'urgent' %}
                                        <span class="badge bg-danger">üî¥ Urgent</span>
                                    {% elif feedback.priority == 'high' %}
                                        <span class="badge bg-warning">üü† High</span>
                                    {% elif feedback.priority == 'medium' %}
                                        <span class="badge bg-primary">üü° Medium</span>
                                    {% else %}
                                        <span class="badge bg-success">üü¢ Low</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Submitted by:</strong>
                                <div class="mt-1">
                                    {% if feedback.user %}
                                        <a href="{{ url_for('profiles.user_profile', username=feedback.user.username) }}" 
                                           class="text-decoration-none">
                                            <i class="fas fa-user me-1"></i>{{ feedback.user.username }}
                                        </a>
                                        <br>
                                        <small class="text-muted">{{ feedback.user.email }}</small>
                                    {% else %}
                                        <span class="text-muted">Anonymous</span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Created:</strong>
                                <div class="mt-1">
                                    <i class="fas fa-calendar me-1"></i>{{ feedback.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <strong>Last Updated:</strong>
                                <div class="mt-1">
                                    <i class="fas fa-clock me-1"></i>{{ feedback.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                </div>
                            </div>
                            
                            {% if feedback.resolved_at %}
                            <div class="mb-3">
                                <strong>Resolved:</strong>
                                <div class="mt-1">
                                    <i class="fas fa-check-circle me-1 text-success"></i>{{ feedback.resolved_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                </div>
                            </div>
                            
                            {% if feedback.resolved_by_user %}
                            <div class="mb-3">
                                <strong>Resolved by:</strong>
                                <div class="mt-1">
                                    <i class="fas fa-user-check me-1"></i>{{ feedback.resolved_by_user.username }}
                                </div>
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Quick Actions</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                {% if feedback.status != 'resolved' %}
                                <button class="btn btn-success btn-sm" onclick="updateFeedbackStatus({{ feedback.id }}, 'resolved')">
                                    <i class="fas fa-check me-1"></i>Mark as Resolved
                                </button>
                                {% endif %}
                                
                                {% if feedback.status != 'in_progress' %}
                                <button class="btn btn-info btn-sm" onclick="updateFeedbackStatus({{ feedback.id }}, 'in_progress')">
                                    <i class="fas fa-play me-1"></i>Mark as In Progress
                                </button>
                                {% endif %}
                                
                                {% if feedback.status != 'closed' %}
                                <button class="btn btn-secondary btn-sm" onclick="updateFeedbackStatus({{ feedback.id }}, 'closed')">
                                    <i class="fas fa-times me-1"></i>Close
                                </button>
                                {% endif %}
                                
                                <button class="btn btn-danger btn-sm" onclick="deleteFeedback({{ feedback.id }})">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Feedback Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    <input type="hidden" id="updateFeedbackId" name="feedback_id">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="mb-3">
                        <label for="updateStatus" class="form-label">Status</label>
                        <select class="form-select" id="updateStatus" name="status" required>
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="updateNotes" class="form-label">Admin Notes</label>
                        <textarea class="form-control" id="updateNotes" name="admin_notes" rows="4" 
                                  placeholder="Add notes about this feedback...">{{ feedback.admin_notes or '' }}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitStatusUpdate()">Update Status</button>
            </div>
        </div>
    </div>
</div>

<script>
function updateFeedbackStatus(feedbackId, currentStatus) {
    document.getElementById('updateFeedbackId').value = feedbackId;
    document.getElementById('updateStatus').value = currentStatus;
    const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
    modal.show();
}

function submitStatusUpdate() {
    const form = document.getElementById('updateStatusForm');
    const formData = new FormData(form);
    const feedbackId = formData.get('feedback_id');
    
    // Remove feedback_id from form data since it's in the URL
    formData.delete('feedback_id');
    
    // Show loading state
    const submitBtn = document.querySelector('#updateStatusModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
    submitBtn.disabled = true;
    
    fetch('/admin/feedback/' + feedbackId + '/update', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Close modal and reload
            const modal = bootstrap.Modal.getInstance(document.getElementById('updateStatusModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating feedback status: ' + error.message);
    })
    .finally(() => {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function deleteFeedback(feedbackId) {
    if (confirm('Are you sure you want to delete this feedback? This action cannot be undone.')) {
        // Get CSRF token from multiple sources
        let csrfToken = '';
        
        // Try to get from meta tag first
        const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
        if (csrfTokenMeta) {
            csrfToken = csrfTokenMeta.getAttribute('content');
        }
        
        // Fallback: try to get from form if available
        if (!csrfToken) {
            const csrfInput = document.querySelector('input[name="csrf_token"]');
            if (csrfInput) {
                csrfToken = csrfInput.value;
            }
        }
        
        // Final fallback: try to get from cookies
        if (!csrfToken) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrf_token') {
                    csrfToken = value;
                    break;
                }
            }
        }
        
        const headers = {
            'Content-Type': 'application/json'
        };
        
        // Add CSRF token if available
        if (csrfToken) {
            headers['X-CSRF-Token'] = csrfToken;
        }
        
        fetch('/admin/feedback/' + feedbackId + '/delete', {
            method: 'POST',
            headers: headers
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                window.location.href = "{{ url_for('feedback.admin_feedback') }}";
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting feedback: ' + error.message);
        });
    }
}
</script>
{% endblock %}
