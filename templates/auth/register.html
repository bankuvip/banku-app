{% extends "base.html" %}

{% block title %}Register - BankU{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card border-0 shadow-lg">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <i class="fas fa-user-plus text-primary fs-1"></i>
                        <h2 class="h3 mb-2">Join BankU</h2>
                        <p class="text-muted">Create your account and start connecting</p>
                    </div>
                    
                    <form id="registerForm" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="first_name" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="first_name" name="first_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="last_name" class="form-label">Last Name</label>
                                <input type="text" class="form-control" id="last_name" name="last_name" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="username" class="form-label">Username</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-user"></i>
                                </span>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                            <div class="invalid-feedback d-block" id="username-error"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-envelope"></i>
                                </span>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            <div class="invalid-feedback d-block" id="email-error"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <input type="password" class="form-control" id="password" name="password" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number (Optional)</label>
                            <div class="input-group">
                                <select class="form-select country-code-select" id="country_code" name="country_code" style="max-width: 200px;" title="Select country code">
                                    <option value="+1" data-country="US">United States +1</option>
                                    <option value="+7" data-country="RU">Russia +7</option>
                                    <option value="+20" data-country="EG">Egypt +20</option>
                                    <option value="+27" data-country="ZA">South Africa +27</option>
                                    <option value="+30" data-country="GR">Greece +30</option>
                                    <option value="+31" data-country="NL">Netherlands +31</option>
                                    <option value="+32" data-country="BE">Belgium +32</option>
                                    <option value="+33" data-country="FR">France +33</option>
                                    <option value="+34" data-country="ES">Spain +34</option>
                                    <option value="+36" data-country="HU">Hungary +36</option>
                                    <option value="+39" data-country="IT">Italy +39</option>
                                    <option value="+40" data-country="RO">Romania +40</option>
                                    <option value="+41" data-country="CH">Switzerland +41</option>
                                    <option value="+43" data-country="AT">Austria +43</option>
                                    <option value="+44" data-country="GB">United Kingdom +44</option>
                                    <option value="+45" data-country="DK">Denmark +45</option>
                                    <option value="+46" data-country="SE">Sweden +46</option>
                                    <option value="+47" data-country="NO">Norway +47</option>
                                    <option value="+48" data-country="PL">Poland +48</option>
                                    <option value="+49" data-country="DE">Germany +49</option>
                                    <option value="+51" data-country="PE">Peru +51</option>
                                    <option value="+52" data-country="MX">Mexico +52</option>
                                    <option value="+53" data-country="CU">Cuba +53</option>
                                    <option value="+54" data-country="AR">Argentina +54</option>
                                    <option value="+55" data-country="BR">Brazil +55</option>
                                    <option value="+56" data-country="CL">Chile +56</option>
                                    <option value="+57" data-country="CO">Colombia +57</option>
                                    <option value="+58" data-country="VE">Venezuela +58</option>
                                    <option value="+60" data-country="MY">Malaysia +60</option>
                                    <option value="+61" data-country="AU">Australia +61</option>
                                    <option value="+62" data-country="ID">Indonesia +62</option>
                                    <option value="+63" data-country="PH">Philippines +63</option>
                                    <option value="+64" data-country="NZ">New Zealand +64</option>
                                    <option value="+65" data-country="SG">Singapore +65</option>
                                    <option value="+66" data-country="TH">Thailand +66</option>
                                    <option value="+81" data-country="JP">Japan +81</option>
                                    <option value="+82" data-country="KR">South Korea +82</option>
                                    <option value="+84" data-country="VN">Vietnam +84</option>
                                    <option value="+86" data-country="CN">China +86</option>
                                    <option value="+90" data-country="TR">Turkey +90</option>
                                    <option value="+91" data-country="IN">India +91</option>
                                    <option value="+92" data-country="PK">Pakistan +92</option>
                                    <option value="+93" data-country="AF">Afghanistan +93</option>
                                    <option value="+94" data-country="LK">Sri Lanka +94</option>
                                    <option value="+95" data-country="MM">Myanmar +95</option>
                                    <option value="+98" data-country="IR">Iran +98</option>
                                    <option value="+212" data-country="MA">Morocco +212</option>
                                    <option value="+213" data-country="DZ">Algeria +213</option>
                                    <option value="+216" data-country="TN">Tunisia +216</option>
                                    <option value="+218" data-country="LY">Libya +218</option>
                                    <option value="+220" data-country="GM">Gambia +220</option>
                                    <option value="+221" data-country="SN">Senegal +221</option>
                                    <option value="+222" data-country="MR">Mauritania +222</option>
                                    <option value="+223" data-country="ML">Mali +223</option>
                                    <option value="+224" data-country="GN">Guinea +224</option>
                                    <option value="+225" data-country="CI">Ivory Coast +225</option>
                                    <option value="+226" data-country="BF">Burkina Faso +226</option>
                                    <option value="+227" data-country="NE">Niger +227</option>
                                    <option value="+228" data-country="TG">Togo +228</option>
                                    <option value="+229" data-country="BJ">Benin +229</option>
                                    <option value="+230" data-country="MU">Mauritius +230</option>
                                    <option value="+231" data-country="LR">Liberia +231</option>
                                    <option value="+232" data-country="SL">Sierra Leone +232</option>
                                    <option value="+233" data-country="GH">Ghana +233</option>
                                    <option value="+234" data-country="NG">Nigeria +234</option>
                                    <option value="+235" data-country="TD">Chad +235</option>
                                    <option value="+236" data-country="CF">Central African Republic +236</option>
                                    <option value="+237" data-country="CM">Cameroon +237</option>
                                    <option value="+238" data-country="CV">Cape Verde +238</option>
                                    <option value="+239" data-country="ST">São Tomé and Príncipe +239</option>
                                    <option value="+240" data-country="GQ">Equatorial Guinea +240</option>
                                    <option value="+241" data-country="GA">Gabon +241</option>
                                    <option value="+242" data-country="CG">Republic of the Congo +242</option>
                                    <option value="+243" data-country="CD">Democratic Republic of the Congo +243</option>
                                    <option value="+244" data-country="AO">Angola +244</option>
                                    <option value="+245" data-country="GW">Guinea-Bissau +245</option>
                                    <option value="+246" data-country="IO">British Indian Ocean Territory +246</option>
                                    <option value="+248" data-country="SC">Seychelles +248</option>
                                    <option value="+249" data-country="SD">Sudan +249</option>
                                    <option value="+250" data-country="RW">Rwanda +250</option>
                                    <option value="+251" data-country="ET">Ethiopia +251</option>
                                    <option value="+252" data-country="SO">Somalia +252</option>
                                    <option value="+253" data-country="DJ">Djibouti +253</option>
                                    <option value="+254" data-country="KE">Kenya +254</option>
                                    <option value="+255" data-country="TZ">Tanzania +255</option>
                                    <option value="+256" data-country="UG">Uganda +256</option>
                                    <option value="+257" data-country="BI">Burundi +257</option>
                                    <option value="+258" data-country="MZ">Mozambique +258</option>
                                    <option value="+260" data-country="ZM">Zambia +260</option>
                                    <option value="+261" data-country="MG">Madagascar +261</option>
                                    <option value="+262" data-country="RE">Réunion +262</option>
                                    <option value="+263" data-country="ZW">Zimbabwe +263</option>
                                    <option value="+264" data-country="NA">Namibia +264</option>
                                    <option value="+265" data-country="MW">Malawi +265</option>
                                    <option value="+266" data-country="LS">Lesotho +266</option>
                                    <option value="+267" data-country="BW">Botswana +267</option>
                                    <option value="+268" data-country="SZ">Eswatini +268</option>
                                    <option value="+269" data-country="KM">Comoros +269</option>
                                    <option value="+290" data-country="SH">Saint Helena +290</option>
                                    <option value="+291" data-country="ER">Eritrea +291</option>
                                    <option value="+297" data-country="AW">Aruba +297</option>
                                    <option value="+298" data-country="FO">Faroe Islands +298</option>
                                    <option value="+299" data-country="GL">Greenland +299</option>
                                    <option value="+350" data-country="GI">Gibraltar +350</option>
                                    <option value="+351" data-country="PT">Portugal +351</option>
                                    <option value="+352" data-country="LU">Luxembourg +352</option>
                                    <option value="+353" data-country="IE">Ireland +353</option>
                                    <option value="+354" data-country="IS">Iceland +354</option>
                                    <option value="+355" data-country="AL">Albania +355</option>
                                    <option value="+356" data-country="MT">Malta +356</option>
                                    <option value="+357" data-country="CY">Cyprus +357</option>
                                    <option value="+358" data-country="FI">Finland +358</option>
                                    <option value="+359" data-country="BG">Bulgaria +359</option>
                                    <option value="+370" data-country="LT">Lithuania +370</option>
                                    <option value="+371" data-country="LV">Latvia +371</option>
                                    <option value="+372" data-country="EE">Estonia +372</option>
                                    <option value="+373" data-country="MD">Moldova +373</option>
                                    <option value="+374" data-country="AM">Armenia +374</option>
                                    <option value="+375" data-country="BY">Belarus +375</option>
                                    <option value="+376" data-country="AD">Andorra +376</option>
                                    <option value="+377" data-country="MC">Monaco +377</option>
                                    <option value="+378" data-country="SM">San Marino +378</option>
                                    <option value="+380" data-country="UA">Ukraine +380</option>
                                    <option value="+381" data-country="RS">Serbia +381</option>
                                    <option value="+382" data-country="ME">Montenegro +382</option>
                                    <option value="+383" data-country="XK">Kosovo +383</option>
                                    <option value="+385" data-country="HR">Croatia +385</option>
                                    <option value="+386" data-country="SI">Slovenia +386</option>
                                    <option value="+387" data-country="BA">Bosnia and Herzegovina +387</option>
                                    <option value="+389" data-country="MK">North Macedonia +389</option>
                                    <option value="+420" data-country="CZ">Czech Republic +420</option>
                                    <option value="+421" data-country="SK">Slovakia +421</option>
                                    <option value="+423" data-country="LI">Liechtenstein +423</option>
                                    <option value="+500" data-country="FK">Falkland Islands +500</option>
                                    <option value="+501" data-country="BZ">Belize +501</option>
                                    <option value="+502" data-country="GT">Guatemala +502</option>
                                    <option value="+503" data-country="SV">El Salvador +503</option>
                                    <option value="+504" data-country="HN">Honduras +504</option>
                                    <option value="+505" data-country="NI">Nicaragua +505</option>
                                    <option value="+506" data-country="CR">Costa Rica +506</option>
                                    <option value="+507" data-country="PA">Panama +507</option>
                                    <option value="+508" data-country="PM">Saint Pierre and Miquelon +508</option>
                                    <option value="+509" data-country="HT">Haiti +509</option>
                                    <option value="+590" data-country="GP">Guadeloupe +590</option>
                                    <option value="+591" data-country="BO">Bolivia +591</option>
                                    <option value="+592" data-country="GY">Guyana +592</option>
                                    <option value="+593" data-country="EC">Ecuador +593</option>
                                    <option value="+594" data-country="GF">French Guiana +594</option>
                                    <option value="+595" data-country="PY">Paraguay +595</option>
                                    <option value="+596" data-country="MQ">Martinique +596</option>
                                    <option value="+597" data-country="SR">Suriname +597</option>
                                    <option value="+598" data-country="UY">Uruguay +598</option>
                                    <option value="+599" data-country="AN">Netherlands Antilles +599</option>
                                    <option value="+670" data-country="TL">East Timor +670</option>
                                    <option value="+672" data-country="AQ">Antarctica +672</option>
                                    <option value="+673" data-country="BN">Brunei +673</option>
                                    <option value="+674" data-country="NR">Nauru +674</option>
                                    <option value="+675" data-country="PG">Papua New Guinea +675</option>
                                    <option value="+676" data-country="TO">Tonga +676</option>
                                    <option value="+677" data-country="SB">Solomon Islands +677</option>
                                    <option value="+678" data-country="VU">Vanuatu +678</option>
                                    <option value="+679" data-country="FJ">Fiji +679</option>
                                    <option value="+680" data-country="PW">Palau +680</option>
                                    <option value="+681" data-country="WF">Wallis and Futuna +681</option>
                                    <option value="+682" data-country="CK">Cook Islands +682</option>
                                    <option value="+683" data-country="NU">Niue +683</option>
                                    <option value="+684" data-country="AS">American Samoa +684</option>
                                    <option value="+685" data-country="WS">Samoa +685</option>
                                    <option value="+686" data-country="KI">Kiribati +686</option>
                                    <option value="+687" data-country="NC">New Caledonia +687</option>
                                    <option value="+688" data-country="TV">Tuvalu +688</option>
                                    <option value="+689" data-country="PF">French Polynesia +689</option>
                                    <option value="+690" data-country="TK">Tokelau +690</option>
                                    <option value="+691" data-country="FM">Micronesia +691</option>
                                    <option value="+692" data-country="MH">Marshall Islands +692</option>
                                    <option value="+850" data-country="KP">North Korea +850</option>
                                    <option value="+852" data-country="HK">Hong Kong +852</option>
                                    <option value="+853" data-country="MO">Macau +853</option>
                                    <option value="+855" data-country="KH">Cambodia +855</option>
                                    <option value="+856" data-country="LA">Laos +856</option>
                                    <option value="+880" data-country="BD">Bangladesh +880</option>
                                    <option value="+886" data-country="TW">Taiwan +886</option>
                                    <option value="+960" data-country="MV">Maldives +960</option>
                                    <option value="+961" data-country="LB">Lebanon +961</option>
                                    <option value="+962" data-country="JO">Jordan +962</option>
                                    <option value="+963" data-country="SY">Syria +963</option>
                                    <option value="+964" data-country="IQ">Iraq +964</option>
                                    <option value="+965" data-country="KW">Kuwait +965</option>
                                    <option value="+966" data-country="SA">Saudi Arabia +966</option>
                                    <option value="+967" data-country="YE">Yemen +967</option>
                                    <option value="+968" data-country="OM">Oman +968</option>
                                    <option value="+970" data-country="PS">Palestine +970</option>
                                    <option value="+971" data-country="AE">United Arab Emirates +971</option>
                                    <option value="+972" data-country="IL">Israel +972</option>
                                    <option value="+973" data-country="BH">Bahrain +973</option>
                                    <option value="+974" data-country="QA">Qatar +974</option>
                                    <option value="+975" data-country="BT">Bhutan +975</option>
                                    <option value="+976" data-country="MN">Mongolia +976</option>
                                    <option value="+977" data-country="NP">Nepal +977</option>
                                    <option value="+992" data-country="TJ">Tajikistan +992</option>
                                    <option value="+993" data-country="TM">Turkmenistan +993</option>
                                    <option value="+994" data-country="AZ">Azerbaijan +994</option>
                                    <option value="+995" data-country="GE">Georgia +995</option>
                                    <option value="+996" data-country="KG">Kyrgyzstan +996</option>
                                    <option value="+998" data-country="UZ">Uzbekistan +998</option>
                                    <option value="+1242" data-country="BS">Bahamas +1242</option>
                                    <option value="+1246" data-country="BB">Barbados +1246</option>
                                    <option value="+1264" data-country="AI">Anguilla +1264</option>
                                    <option value="+1268" data-country="AG">Antigua and Barbuda +1268</option>
                                    <option value="+1284" data-country="VG">British Virgin Islands +1284</option>
                                    <option value="+1340" data-country="VI">U.S. Virgin Islands +1340</option>
                                    <option value="+1345" data-country="KY">Cayman Islands +1345</option>
                                    <option value="+1441" data-country="BM">Bermuda +1441</option>
                                    <option value="+1473" data-country="GD">Grenada +1473</option>
                                    <option value="+1649" data-country="TC">Turks and Caicos Islands +1649</option>
                                    <option value="+1664" data-country="MS">Montserrat +1664</option>
                                    <option value="+1670" data-country="MP">Northern Mariana Islands +1670</option>
                                    <option value="+1671" data-country="GU">Guam +1671</option>
                                    <option value="+1684" data-country="AS">American Samoa +1684</option>
                                    <option value="+1721" data-country="SX">Sint Maarten +1721</option>
                                    <option value="+1758" data-country="LC">Saint Lucia +1758</option>
                                    <option value="+1767" data-country="DM">Dominica +1767</option>
                                    <option value="+1784" data-country="VC">Saint Vincent and the Grenadines +1784</option>
                                    <option value="+1787" data-country="PR">Puerto Rico +1787</option>
                                    <option value="+1809" data-country="DO">Dominican Republic +1809</option>
                                    <option value="+1829" data-country="DO">Dominican Republic +1829</option>
                                    <option value="+1849" data-country="DO">Dominican Republic +1849</option>
                                    <option value="+1868" data-country="TT">Trinidad and Tobago +1868</option>
                                    <option value="+1869" data-country="KN">Saint Kitts and Nevis +1869</option>
                                    <option value="+1876" data-country="JM">Jamaica +1876</option>
                                    <option value="+1939" data-country="PR">Puerto Rico +1939</option>
                                </select>
                                <input type="tel" class="form-control" id="phone" name="phone" placeholder="Phone number">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="location" class="form-label">Location (Optional)</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-map-marker-alt"></i>
                                </span>
                                <input type="text" class="form-control" id="location" name="location" placeholder="City, Country">
                            </div>
                        </div>
                        
                        
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="terms" required>
                            <label class="form-check-label" for="terms">
                                I agree to the <a href="#" class="text-decoration-none">Terms of Service</a> and <a href="#" class="text-decoration-none">Privacy Policy</a>
                            </label>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-user-plus me-2"></i>Create Account
                            </button>
                        </div>
                    </form>
                    
                    <div class="text-center mt-4">
                        <p class="mb-0">Already have an account? 
                            <a href="{{ url_for('auth.login') }}" class="text-decoration-none">Sign in here</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.invalid-feedback {
    display: none;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}

.invalid-feedback.show {
    display: block !important;
}

.is-invalid ~ .invalid-feedback {
    display: block !important;
}

    .country-code-select {
        font-size: 0.9rem;
        padding: 0.375rem 0.5rem;
        min-width: 180px;
        width: 200px;
    }

    .country-code-select option {
        padding: 0.5rem;
        font-size: 0.9rem;
    }

    /* Make the country code dropdown more compact */
    .input-group .country-code-select {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
        border-right: 0;
        flex: 0 0 200px;
    }

    .input-group .country-code-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        z-index: 3;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Set default country code to US and add search functionality
document.addEventListener('DOMContentLoaded', function() {
    const countrySelect = document.getElementById('country_code');
    
    // Function to detect country from IP
    async function detectCountry() {
        try {
            // Try to get country from IP geolocation
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            
            // Map country codes to phone codes
            const countryToPhoneCode = {
                'EG': '+20', 'US': '+1', 'GB': '+44', 'DE': '+49', 'FR': '+33', 'IT': '+39',
                'ES': '+34', 'NL': '+31', 'BE': '+32', 'CH': '+41', 'AT': '+43', 'SE': '+46',
                'NO': '+47', 'DK': '+45', 'FI': '+358', 'PL': '+48', 'CZ': '+420', 'HU': '+36',
                'RO': '+40', 'BG': '+359', 'HR': '+385', 'SI': '+386', 'SK': '+421', 'LT': '+370',
                'LV': '+371', 'EE': '+372', 'IE': '+353', 'PT': '+351', 'GR': '+30', 'CY': '+357',
                'MT': '+356', 'LU': '+352', 'MC': '+377', 'SM': '+378', 'VA': '+39', 'AD': '+376',
                'LI': '+423', 'IS': '+354', 'AL': '+355', 'MD': '+373', 'AM': '+374', 'BY': '+375',
                'UA': '+380', 'RS': '+381', 'ME': '+382', 'XK': '+383', 'BA': '+387', 'MK': '+389',
                'MA': '+212', 'DZ': '+213', 'TN': '+216', 'LY': '+218', 'GM': '+220', 'SN': '+221',
                'MR': '+222', 'ML': '+223', 'GN': '+224', 'CI': '+225', 'BF': '+226', 'NE': '+227',
                'TG': '+228', 'BJ': '+229', 'MU': '+230', 'LR': '+231', 'SL': '+232', 'GH': '+233',
                'NG': '+234', 'TD': '+235', 'CF': '+236', 'CM': '+237', 'CV': '+238', 'ST': '+239',
                'GQ': '+240', 'GA': '+241', 'CG': '+242', 'CD': '+243', 'AO': '+244', 'GW': '+245',
                'IO': '+246', 'SC': '+248', 'SD': '+249', 'RW': '+250', 'ET': '+251', 'SO': '+252',
                'DJ': '+253', 'KE': '+254', 'TZ': '+255', 'UG': '+256', 'BI': '+257', 'MZ': '+258',
                'ZM': '+260', 'MG': '+261', 'RE': '+262', 'ZW': '+263', 'NA': '+264', 'MW': '+265',
                'LS': '+266', 'BW': '+267', 'SZ': '+268', 'KM': '+269', 'SH': '+290', 'ER': '+291',
                'AW': '+297', 'FO': '+298', 'GL': '+299', 'GI': '+350', 'TL': '+670', 'AQ': '+672',
                'BN': '+673', 'NR': '+674', 'PG': '+675', 'TO': '+676', 'SB': '+677', 'VU': '+678',
                'FJ': '+679', 'PW': '+680', 'WF': '+681', 'CK': '+682', 'NU': '+683', 'AS': '+684',
                'WS': '+685', 'KI': '+686', 'NC': '+687', 'TV': '+688', 'PF': '+689', 'TK': '+690',
                'FM': '+691', 'MH': '+692', 'KP': '+850', 'HK': '+852', 'MO': '+853', 'KH': '+855',
                'LA': '+856', 'BD': '+880', 'TW': '+886', 'MV': '+960', 'LB': '+961', 'JO': '+962',
                'SY': '+963', 'IQ': '+964', 'KW': '+965', 'SA': '+966', 'YE': '+967', 'OM': '+968',
                'PS': '+970', 'AE': '+971', 'IL': '+972', 'BH': '+973', 'QA': '+974', 'BT': '+975',
                'MN': '+976', 'NP': '+977', 'TJ': '+992', 'TM': '+993', 'AZ': '+994', 'GE': '+995',
                'KG': '+996', 'UZ': '+998', 'BS': '+1242', 'BB': '+1246', 'AI': '+1264', 'AG': '+1268',
                'VG': '+1284', 'VI': '+1340', 'KY': '+1345', 'BM': '+1441', 'GD': '+1473', 'TC': '+1649',
                'MS': '+1664', 'MP': '+1670', 'GU': '+1671', 'SX': '+1721', 'LC': '+1758', 'DM': '+1767',
                'VC': '+1784', 'PR': '+1787', 'DO': '+1809', 'TT': '+1868', 'KN': '+1869', 'JM': '+1876'
            };
            
            const detectedCountry = countryToPhoneCode[data.country_code];
            if (detectedCountry && countrySelect) {
                countrySelect.value = detectedCountry;
                return;
            }
        } catch (error) {
            console.log('Could not detect country from IP:', error);
        }
        
        // Fallback: Try to get country from browser language
        const browserLang = navigator.language || navigator.userLanguage;
        const langCode = browserLang.split('-')[0].toUpperCase();
        
        const langToCountry = {
            'EN': '+1', 'AR': '+20', 'FR': '+33', 'DE': '+49', 'IT': '+39', 'ES': '+34',
            'NL': '+31', 'PT': '+351', 'RU': '+7', 'ZH': '+86', 'JA': '+81', 'KO': '+82',
            'TR': '+90', 'PL': '+48', 'SV': '+46', 'NO': '+47', 'DA': '+45', 'FI': '+358',
            'CS': '+420', 'HU': '+36', 'RO': '+40', 'BG': '+359', 'HR': '+385', 'SK': '+421',
            'LT': '+370', 'LV': '+371', 'ET': '+372', 'EL': '+30', 'HE': '+972', 'TH': '+66',
            'VI': '+84', 'ID': '+62', 'MS': '+60', 'TL': '+670'
        };
        
        const fallbackCountry = langToCountry[langCode];
        if (fallbackCountry && countrySelect && !countrySelect.value) {
            countrySelect.value = fallbackCountry;
            return;
        }
        
        // Final fallback: Default to United States if nothing else works
        if (countrySelect && !countrySelect.value) {
            countrySelect.value = '+1';
        }
    }
    
    // Call the detection function
    detectCountry();
    
    // Add search functionality to country code dropdown
    countrySelect.addEventListener('focus', function() {
        this.size = Math.min(10, this.options.length); // Show max 10 options
    });
    
    countrySelect.addEventListener('blur', function() {
        this.size = 1; // Reset to single option view
    });
    
    // Add keyboard search functionality
    let searchTimeout;
    countrySelect.addEventListener('keydown', function(e) {
        clearTimeout(searchTimeout);
        if (e.key.length === 1) { // Only for character keys
            const searchChar = e.key.toLowerCase();
            const options = Array.from(this.options);
            
            // Find option that starts with the typed character
            const foundOption = options.find(option => 
                option.textContent.toLowerCase().includes(searchChar)
            );
            
            if (foundOption) {
                this.value = foundOption.value;
            }
        }
    });
});

// Real-time validation for username and email
document.getElementById('username').addEventListener('blur', function() {
    validateField('username', this.value);
});

document.getElementById('email').addEventListener('blur', function() {
    validateField('email', this.value);
});

function validateField(field, value) {
    if (!value) return;
    
    // Get CSRF token from the form
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    fetch('{{ url_for("auth.validate_field") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({field: field, value: value})
    })
    .then(response => response.json())
    .then(result => {
        const input = document.getElementById(field);
        const errorDiv = document.getElementById(field + '-error');
        
        if (result.available) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
            errorDiv.textContent = '';
            errorDiv.classList.remove('show');
        } else {
            input.classList.remove('is-valid');
            input.classList.add('is-invalid');
            errorDiv.textContent = result.message;
            errorDiv.classList.add('show');
        }
    })
    .catch(error => {
        console.error('Validation error:', error);
    });
}

document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Clear previous validation states
    document.querySelectorAll('.is-invalid, .is-valid').forEach(el => {
        el.classList.remove('is-invalid', 'is-valid');
    });
    document.querySelectorAll('.invalid-feedback').forEach(el => {
        el.textContent = '';
    });
    
    // Combine country code with phone number if phone is provided
    const countryCode = document.getElementById('country_code').value;
    const phoneNumber = document.getElementById('phone').value;
    let fullPhoneNumber = phoneNumber;
    
    if (phoneNumber && phoneNumber.trim()) {
        // Remove any existing country code from the phone number
        const cleanPhone = phoneNumber.replace(/^\+\d{1,4}/, '').trim();
        fullPhoneNumber = countryCode + cleanPhone;
    }
    
    const formData = new FormData(this);
    formData.set('phone', fullPhoneNumber); // Override with the combined phone number
    const data = Object.fromEntries(formData);
    
    try {
        // Get CSRF token from the form
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        
        const response = await fetch('{{ url_for("auth.register") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            window.location.href = result.redirect;
        } else {
            // Show inline error messages
            if (result.field === 'username') {
                const usernameInput = document.getElementById('username');
                const usernameError = document.getElementById('username-error');
                usernameInput.classList.add('is-invalid');
                usernameError.textContent = result.message;
                usernameError.classList.add('show');
            } else if (result.field === 'email') {
                const emailInput = document.getElementById('email');
                const emailError = document.getElementById('email-error');
                emailInput.classList.add('is-invalid');
                emailError.textContent = result.message;
                emailError.classList.add('show');
            } else {
                alert(result.message);
            }
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    }
});
</script>
{% endblock %}

